# MOVEit Transfer Critical Vulnerability (May 2023) (CVE-2023-34362)
# https://community.progress.com/s/article/MOVEit-Transfer-Critical-Vulnerability-31May2023
# Recommended Remediation
# 1. Disable all HTTP and HTTPs traffic to your MOVEit Transfer environment
#                    - It is important to note, that until HTTP and HTTPS traffic is enabled again: 
#                       - Users will not be able to log on to the MOVEit Transfer web UI  
#                       - MOVEit Automation tasks that use the native MOVEit Transfer host will not work 
#                       - REST, Java and .NET APIs will not work 
#                       - MOVEit Transfer add-in for Outlook will not work 
#                    - SFTP and FTP/s protocols will continue to work as normal 
---
- name: Windows and MOVEit HTTP and HTTPS Firewall Block
  hosts: all
  vars:
    - ansible_become_method: runas # Since Ansible 2.3, privilege elevation can be used on Windows hosts through the runas method: https://docs.ansible.com/ansible/2.7/user_guide/become.html#become-and-windows
    - ansible_become_user: {{ ansible_user }}
  tasks:
    - name: Disable all inbound and outbound HTTP and HTTPS traffic to your MOVEit Transfer environment through Firewall Rules
      ansible.windows.win_powershell:
        script: |
          New-NetFirewallRule -DisplayName "MOVEit HTTP default inbound block" -Direction Inbound -LocalPort 80 -Protocol TCP -Action Block

          New-NetFirewallRule -DisplayName "MOVEit HTTPS default inbound block" -Direction Inbound -LocalPort 443 -Protocol TCP -Action Block

          New-NetFirewallRule -DisplayName "MOVEit HTTP default outbound block" -Direction Outbound -LocalPort 80 -Protocol TCP -Action Block
          
          New-NetFirewallRule -DisplayName "MOVEit HTTPS default outbound block" -Direction Outbound -LocalPort 443 -Protocol TCP -Action Block
      become: yes
      
    # Should ONLY be run after verification of a safe and remediated server
    # Since Ansible 2.5, If you assign the 'never' tag to a task or play, Ansible will skip that task or play unless you specifically request it (--tags never)
    - name: Remove the new Firewall Rules
      ansible.windows.win_powershell:
        script: |
          Remove-NetFirewallRule –DisplayName “MOVEit HTTP default inbound block”
          Remove-NetFirewallRule –DisplayName “MOVEit HTTPS default inbound block”
          Remove-NetFirewallRule –DisplayName “MOVEit HTTP default outbound block”
          Remove-NetFirewallRule –DisplayName “MOVEit HTTPS default outbound block"
      tags: [ never ]    
      become: yes
